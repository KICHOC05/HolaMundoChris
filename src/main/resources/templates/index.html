<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola Mundo - Aplicación Spring Boot</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark shadow">
    <div class="container">
        <a class="navbar-brand" href="/">Hola Mundo</a>

        <div>
            <a th:href="@{/register}" class="btn btn-outline-light me-2">Registro</a>
            <a th:href="@{/login}" class="btn btn-outline-info me-2">Login</a>
            <a th:href="@{/users}" class="btn btn-outline-success">Usuarios</a>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <div class="text-center mb-4">
        <h1 class="fw-bold">Hola Mundo</h1>
        <h5 class="text-muted">Christopher Camargo Gonzalez</h5>
    </div>

    <div class="row g-4">

        <!-- Registro -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Registro de Usuario</h5>
                    <p>Formulario con validación y reCAPTCHA.</p>
                    <a th:href="@{/register}" class="btn btn-primary w-100">
                        Ir al Registro
                    </a>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Prueba Error 404</h5>
                    <p>Simula página inexistente.</p>
                    <a th:href="@{/PaginaInexistente}" class="btn btn-danger w-100">
                        Generar Error
                    </a>
                </div>
            </div>
        </div>

        <!-- Galería -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5>Galería de Imágenes</h5>
                    <p>Sube y visualiza imágenes JPG/JPEG.</p>
                    <button onclick="showImageSection()" class="btn btn-success w-100">
                        Mostrar Galería
                    </button>
                </div>
            </div>
        </div>
		<!-- CRUD Usuarios -->
		<div class="col-md-4">
		    <div class="card shadow-sm border-success">
		        <div class="card-body">
		            <h5 class="text-success">CRUD de Usuarios</h5>
		            <p>Administrar, editar y eliminar usuarios registrados.</p>
		            <a th:href="@{/users}" class="btn btn-success w-100">
		                Ir al CRUD
		            </a>
		        </div>
		    </div>
		</div>

    </div>

    <!-- GALERÍA -->
    <div id="imageSection" class="mt-5" style="display:none;">

        <div class="card shadow">
            <div class="card-body">

                <h4>Galería de Imágenes</h4>

                <input type="file" id="fileInput" accept=".jpg,.jpeg" class="form-control mb-3">

                <div id="previewContainer" style="display:none;" class="mb-3">
                    <img id="preview" class="img-thumbnail" style="max-width:200px;">
                </div>

                <div id="uploadMessage" class="mb-3"></div>

                <button onclick="uploadImage()" class="btn btn-primary">
                    Subir Imagen
                </button>

                <hr>

                <div id="carouselContainer" class="text-center">
                    <div id="carouselInner"></div>

                    <div class="mt-3">
                        <button onclick="previousImage()" class="btn btn-secondary">
                            ← Anterior
                        </button>

                        <span id="imageCounter" class="mx-3">0 / 0</span>

                        <button onclick="nextImage()" class="btn btn-secondary">
                            Siguiente →
                        </button>
                    </div>

                    <div id="deleteButton" class="mt-3" style="display:none;">
                        <button onclick="deleteCurrentImage()" class="btn btn-danger">
                            Eliminar Imagen
                        </button>
                    </div>
                </div>

                <div id="noImagesMessage" class="text-muted text-center">
                    No hay imágenes subidas todavía.
                </div>

                <button onclick="hideImageSection()" class="btn btn-outline-dark mt-3">
                    Cerrar Galería
                </button>

            </div>
        </div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ==================== JAVASCRIPT COMPLETO ==================== -->
<script>

let uploadedImages = [];
let currentImageIndex = 0;

const API_URL = window.location.origin + '/api/imagenes';

const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

function showImageSection() {
    document.getElementById('imageSection').style.display = 'block';
    loadUploadedImages();
}

function hideImageSection() {
    document.getElementById('imageSection').style.display = 'none';
}

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const previewContainer = document.getElementById('previewContainer');
    const preview = document.getElementById('preview');

    previewContainer.style.display = 'none';

    if (file) {
        const validTypes = ['image/jpeg', 'image/jpg'];
        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (!validTypes.includes(file.type) ||
            (fileExtension !== 'jpg' && fileExtension !== 'jpeg')) {
            showMessage('Solo se permiten archivos JPEG/JPG', 'danger');
            e.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
        }
        reader.readAsDataURL(file);
    }
});

async function uploadImage() {

    const fileInput = document.getElementById('fileInput');

    if (!fileInput.files[0]) {
        showMessage('Selecciona una imagen', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('imagen', fileInput.files[0]);

    const headers = {};
    if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
    }

    try {

        showMessage('Subiendo imagen...', 'info');

        const response = await fetch(API_URL + '/subir', {
            method: 'POST',
            headers: headers,
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showMessage('Imagen subida correctamente', 'success');
            fileInput.value = '';
            document.getElementById('previewContainer').style.display = 'none';
            await loadUploadedImages();
        } else {
            showMessage(result.message, 'danger');
        }

    } catch (error) {
        showMessage('Error de conexión', 'danger');
    }
}

async function loadUploadedImages() {

    const response = await fetch(API_URL);
    const result = await response.json();

    if (result.success && result.data.length > 0) {
        uploadedImages = result.data;
        displayImage(0);
        document.getElementById('carouselContainer').style.display = 'block';
        document.getElementById('noImagesMessage').style.display = 'none';
        document.getElementById('deleteButton').style.display = 'block';
    } else {
        document.getElementById('carouselContainer').style.display = 'none';
        document.getElementById('deleteButton').style.display = 'none';
        document.getElementById('noImagesMessage').style.display = 'block';
    }
}

function displayImage(index) {

    if (uploadedImages.length === 0) return;

    if (index < 0) index = uploadedImages.length - 1;
    if (index >= uploadedImages.length) index = 0;

    currentImageIndex = index;
    const imagen = uploadedImages[index];

    const imageUrl = imagen.url.startsWith('http')
        ? imagen.url
        : window.location.origin + imagen.url;

    document.getElementById('carouselInner').innerHTML = `
        <img src="${imageUrl}" class="img-fluid" style="max-height:400px;">
        <p>ID: ${imagen.id}</p>
    `;

    document.getElementById('imageCounter').textContent =
        (index + 1) + ' / ' + uploadedImages.length;
}

function previousImage() {
    displayImage(currentImageIndex - 1);
}

function nextImage() {
    displayImage(currentImageIndex + 1);
}

async function deleteCurrentImage() {

    const imagen = uploadedImages[currentImageIndex];

    if (!confirm('¿Eliminar imagen?')) return;

    await fetch(`${API_URL}/${imagen.id}`, { method: 'DELETE' });

    await loadUploadedImages();
}

function showMessage(text, type) {
    document.getElementById('uploadMessage').innerHTML =
        `<div class="alert alert-${type}">${text}</div>`;
}

</script>

</body>
</html>