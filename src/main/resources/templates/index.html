<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hola Mundo - Aplicación Spring Boot</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <!-- Token CSRF para protección -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

    <!-- Breadcrumbs que muestran la ruta actual del HTML -->
    <div style="padding: 8px; background-color: #f5f5f5; border: 1px solid #ddd; margin-bottom: 15px; font-size: 14px;">
        <strong>Ubicación:</strong> 
        <span>Inicio</span>
        <span style="color: #666;"> &gt; index.html</span>
    </div>

    <header>
        <h1>Hola Mundo</h1>
        <h2>Christopher Camargo Gonzalez</h2>
        <hr>
    </header>
    <main>

        <section>
            <h3>Acciones disponibles:</h3>
            
            <article>
                <h4>Registro de Usuario</h4>
                <p>Formulario de registro con validación completa y protección reCAPTCHA.</p>
                <form th:action="@{/register}" method="get">
                    <button type="submit">
                        <strong>Ir al Registro</strong><br>
                        <small>Formulario con reCAPTCHA</small>
                    </button>
                </form>
            </article>

            <article>
                <h4>Prueba de Error 404</h4>
                <p>Simula una página no encontrada para probar el manejo de errores.</p>
                <form th:action="@{/PaginaInexistente}" method="get">
                    <button type="submit">
                        <strong>Generar Error 404</strong><br>
                        <small>Prueba de página no encontrada</small>
                    </button>
                </form>
            </article>

            <article>
                <h4>Subir y Ver Imágenes</h4>
                <p>Sube imágenes JPG/JPEG y visualízalas en un carrusel simple.</p>
                <button onclick="showImageSection()">
                    <strong>Mostrar Galería</strong><br>
                    <small>Subir y ver imágenes</small>
                </button>
            </article>
        </section>

        <!-- Sección de Imágenes (inicialmente oculta) -->
        <section id="imageSection" style="display:none; margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px;">
            <h3>Galería de Imágenes</h3>
            
            <!-- Formulario para subir imágenes -->
            <div style="margin-bottom: 20px;">
                <h4>Subir Nueva Imagen</h4>
                <div>
                    <label>Selecciona una imagen (solo JPG/JPEG):</label><br>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg">
                </div>
                
                <div id="previewContainer" style="display: none; margin: 10px 0;">
                    <p>Vista previa:</p>
                    <img id="preview" style="max-width: 200px;">
                </div>
                
                <div id="uploadMessage" style="margin: 10px 0;"></div>
                
                <button type="button" onclick="uploadImage()">
                    Subir Imagen
                </button>
            </div>
            
            <!-- Carrusel de imágenes -->
            <div style="border: 1px solid #ccc; padding: 20px;">
                <h4>Imágenes Subidas</h4>
                
                <div id="carouselContainer" style="text-align: center;">
                    <div id="carouselInner">
                        <!-- Las imágenes se cargarán aquí -->
                    </div>
                    
                    <div id="carouselControls" style="margin-top: 15px;">
                        <button onclick="previousImage()">← Anterior</button>
                        <span id="imageCounter" style="margin: 0 15px;">0 / 0</span>
                        <button onclick="nextImage()">Siguiente →</button>
                    </div>
                    
                    <div id="deleteButton" style="margin-top: 15px; display: none;">
                        <button onclick="deleteCurrentImage()" style="background-color: #dc3545; color: white;">
                            Eliminar Imagen Actual
                        </button>
                    </div>
                </div>
                
                <div id="noImagesMessage">
                    <p>No hay imágenes subidas todavía.</p>
                    <p>Sube una imagen usando el formulario de arriba.</p>
                </div>
            </div>
            
            <button onclick="hideImageSection()" style="margin-top: 20px;">Cerrar Galería</button>
        </section>

        <section>
            <h3>Configuración de Seguridad</h3>
            <p>Esta aplicación está protegida con Google reCAPTCHA v2</p>
            <div class="g-recaptcha" data-sitekey="6LfH9kksAAAAABN2dwmuUkvNufvH83ty4-48Cwkg"></div>
            <p><small>El reCAPTCHA verifica que no eres un robot</small></p>
        </section>
    </main>

    <script>
        // Variables globales
        let uploadedImages = [];
        let currentImageIndex = 0;
        
        // URL DINÁMICA para Render.com - ESTA ES LA SOLUCIÓN
        const API_URL = window.location.origin + '/api/imagenes';
        console.log('API URL configurada:', API_URL);
        console.log('Dominio actual:', window.location.origin);
        
        // Obtener token CSRF de los meta tags
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        
        // Mostrar/ocultar la sección de imágenes
        function showImageSection() {
            document.getElementById('imageSection').style.display = 'block';
            loadUploadedImages();
        }
        
        function hideImageSection() {
            document.getElementById('imageSection').style.display = 'none';
        }
        
        // Mostrar vista previa de la imagen seleccionada
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewContainer = document.getElementById('previewContainer');
            const preview = document.getElementById('preview');
            
            previewContainer.style.display = 'none';
            
            if (file) {
                // Validar tipo de archivo
                const validTypes = ['image/jpeg', 'image/jpg'];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(file.type) || 
                    (fileExtension !== 'jpg' && fileExtension !== 'jpeg')) {
                    showMessage('Solo se permiten archivos JPEG/JPG', 'error');
                    e.target.value = '';
                    return;
                }
                
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Subir imagen
        async function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const message = document.getElementById('uploadMessage');
            
            if (!fileInput.files[0]) {
                showMessage('Por favor, selecciona una imagen', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('imagen', fileInput.files[0]);
            
            // Para Render.com, prueba sin CSRF primero
            const headers = {};
            
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
                console.log('Usando CSRF token');
            } else {
                console.log('CSRF no disponible, enviando sin headers');
            }
            
            try {
                showMessage('Subiendo imagen...', 'info');
                console.log('Enviando a:', API_URL + '/subir');
                
                const response = await fetch(API_URL + '/subir', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                console.log('Respuesta recibida, status:', response.status);
                
                const result = await response.json();
                console.log('Resultado:', result);
                
                if (result.success) {
                    showMessage('✅ Imagen subida exitosamente', 'success');
                    fileInput.value = '';
                    document.getElementById('previewContainer').style.display = 'none';
                    await loadUploadedImages();
                } else {
                    showMessage('❌ ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error completo:', error);
                showMessage('❌ Error de conexión: ' + error.message, 'error');
            }
        }
        
        // Cargar imágenes desde el servidor
        async function loadUploadedImages() {
            console.log('Cargando imágenes desde:', API_URL);
            
            try {
                const headers = {};
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }
                
                const response = await fetch(API_URL, {
                    headers: headers
                });
                
                console.log('Status de carga:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Imágenes cargadas:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        uploadedImages = result.data;
                        showCarousel();
                        displayImage(0);
                    } else {
                        hideCarousel();
                    }
                } else {
                    console.error('Error al cargar imágenes, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error detalle:', errorText);
                    hideCarousel();
                }
            } catch (error) {
                console.error('Error de conexión al cargar imágenes:', error);
                hideCarousel();
            }
        }
        
        // Mostrar/ocultar carrusel
        function showCarousel() {
            document.getElementById('noImagesMessage').style.display = 'none';
            document.getElementById('carouselContainer').style.display = 'block';
            document.getElementById('deleteButton').style.display = 'block';
        }
        
        function hideCarousel() {
            document.getElementById('noImagesMessage').style.display = 'block';
            document.getElementById('carouselContainer').style.display = 'none';
            document.getElementById('deleteButton').style.display = 'none';
        }
        
        // Mostrar una imagen específica en el carrusel
        function displayImage(index) {
            if (uploadedImages.length === 0) {
                hideCarousel();
                return;
            }
            
            // Ajustar índice si es necesario
            if (index < 0) index = uploadedImages.length - 1;
            if (index >= uploadedImages.length) index = 0;
            
            currentImageIndex = index;
            const imagen = uploadedImages[currentImageIndex];
            
            // IMPORTANTE: Usar URL absoluta para las imágenes
            const imageUrl = imagen.url.startsWith('http') 
                ? imagen.url 
                : window.location.origin + imagen.url;
            
            console.log('Mostrando imagen URL:', imageUrl);
            
            // Crear o actualizar la imagen en el carrusel
            const carouselInner = document.getElementById('carouselInner');
            carouselInner.innerHTML = `
                <img src="${imageUrl}" 
                     alt="Imagen ${imagen.id}" 
                     style="max-width: 100%; max-height: 400px;">
                <p>ID: ${imagen.id} | Subida: ${new Date(imagen.fechaSubida).toLocaleDateString()}</p>
            `;
            
            // Actualizar contador
            document.getElementById('imageCounter').textContent = 
                (currentImageIndex + 1) + ' / ' + uploadedImages.length;
        }
        
        // Navegación del carrusel
        function previousImage() {
            if (uploadedImages.length === 0) return;
            displayImage(currentImageIndex - 1);
        }
        
        function nextImage() {
            if (uploadedImages.length === 0) return;
            displayImage(currentImageIndex + 1);
        }
        
        // Eliminar imagen actual
        async function deleteCurrentImage() {
            if (uploadedImages.length === 0) return;
            
            const imagen = uploadedImages[currentImageIndex];
            
            if (!confirm(`¿Estás seguro de que quieres eliminar la imagen con ID ${imagen.id}?`)) {
                return;
            }
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }
                
                const response = await fetch(`${API_URL}/${imagen.id}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('✅ Imagen eliminada exitosamente', 'success');
                    
                    // Recargar la lista de imágenes
                    await loadUploadedImages();
                    
                    // Si todavía hay imágenes, mostrar la primera
                    if (uploadedImages.length > 0) {
                        displayImage(0);
                    }
                } else {
                    showMessage('❌ ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('❌ Error al eliminar la imagen', 'error');
                console.error('Error:', error);
            }
        }
        
        // Mostrar mensajes
        function showMessage(texto, tipo) {
            const messageDiv = document.getElementById('uploadMessage');
            let color = 'black';
            
            switch(tipo) {
                case 'success': color = 'green'; break;
                case 'error': color = 'red'; break;
                case 'warning': color = 'orange'; break;
                case 'info': color = 'blue'; break;
            }
            
            messageDiv.innerHTML = `<p style="color: ${color};">${texto}</p>`;
            
            // Limpiar mensaje después de 5 segundos
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
        
        // Test de conexión al iniciar
        console.log('=== INICIALIZANDO APLICACIÓN ===');
        console.log('URL Base:', window.location.origin);
        console.log('API URL:', API_URL);
        console.log('CSRF disponible:', !!csrfToken);
        
    </script>
</body>
</html>